{% extends "base.html" %}
{% load static %}

{% block title %}Track Your Progress - TrainWise{% endblock %}
{% block body_class %}class="hide-navbar"{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/dashboard.css' %}">
<style>
    .track-progress-container {
        display: flex;
        min-height: 100vh;
        background: linear-gradient(to bottom, #f9fafb, #ffffff);
    }

    .track-progress-content {
        flex: 1;
        padding: var(--space-xl);
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
    }

    .track-progress-header {
        margin-bottom: var(--space-xl);
    }

    .track-progress-header h1 {
        color: var(--color-text-primary);
        margin-bottom: var(--space-sm);
    }

    .track-progress-header p {
        color: var(--color-text-secondary);
        font-size: 1.1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: var(--space-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(16, 185, 129, 0.1);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
        border-color: rgba(16, 185, 129, 0.3);
    }

    .stat-label {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
        margin-bottom: var(--space-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        color: var(--color-text-primary);
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: baseline;
        gap: var(--space-xs);
    }

    .stat-unit {
        font-size: 1rem;
        color: var(--color-text-secondary);
        font-weight: 400;
    }

    .stat-change {
        margin-top: var(--space-xs);
        font-size: 0.9rem;
        font-weight: 600;
    }

    .stat-change.positive {
        color: #059669;
    }

    .stat-change.negative {
        color: #dc2626;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xl);
        margin-bottom: var(--space-xl);
    }

    .log-weight-card,
    .chart-card {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: var(--space-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(16, 185, 129, 0.1);
    }

    .card-header {
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 2px solid rgba(16, 185, 129, 0.1);
    }

    .card-header h2 {
        color: var(--color-text-primary);
        font-size: 1.5rem;
        margin-bottom: var(--space-xs);
    }

    .card-header p {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
    }

    .form-group {
        margin-bottom: var(--space-md);
    }

    .form-group label {
        display: block;
        color: var(--color-text-primary);
        font-weight: 600;
        margin-bottom: var(--space-xs);
    }

    .form-control {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    .time-period-selector {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .time-period-btn {
        padding: var(--space-sm) var(--space-md);
        border: 2px solid #e5e7eb;
        background: white;
        color: var(--color-text-secondary);
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .time-period-btn:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
    }

    .time-period-btn.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }

    #weightChart {
        max-height: 300px;
    }

    .history-card {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: var(--space-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(16, 185, 129, 0.1);
    }

    .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: var(--space-md);
    }

    .history-table th {
        background: rgba(16, 185, 129, 0.05);
        padding: var(--space-md);
        text-align: left;
        color: var(--color-text-primary);
        font-weight: 600;
        border-bottom: 2px solid rgba(16, 185, 129, 0.2);
    }

    .history-table td {
        padding: var(--space-md);
        border-bottom: 1px solid #e5e7eb;
        color: var(--color-text-secondary);
    }

    .history-table tr:hover {
        background: rgba(16, 185, 129, 0.02);
    }

    .delete-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-xl);
        color: var(--color-text-secondary);
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-md);
        opacity: 0.3;
    }

    @media (max-width: 968px) {
        .content-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .track-progress-content {
            padding: var(--space-md);
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="track-progress-container">
    {% include "user/components/sidebar_nav.html" %}
    
    <div class="track-progress-content">
        <div class="track-progress-header">
            <h1>Track Your Progress</h1>
            <p>Monitor your weight journey and stay on track with your fitness goals</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Starting Weight</div>
                <div class="stat-value">
                    {{ stats.first_weight|floatformat:1|default:"--" }}
                    <span class="stat-unit">kg</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Current Weight</div>
                <div class="stat-value">
                    {{ stats.latest_weight|floatformat:1|default:"--" }}
                    <span class="stat-unit">kg</span>
                </div>
                {% if stats.latest_bmi %}
                <div class="stat-change">BMI: {{ stats.latest_bmi }}</div>
                {% endif %}
            </div>

            <div class="stat-card">
                <div class="stat-label">Total Change</div>
                <div class="stat-value">
                    {% if stats.weight_change %}
                        {{ stats.weight_change|floatformat:1 }}
                        <span class="stat-unit">kg</span>
                    {% else %}
                        --
                    {% endif %}
                </div>
                {% if stats.weight_change %}
                <div class="stat-change {% if stats.weight_change > 0 %}positive{% else %}negative{% endif %}">
                    {% if stats.weight_change > 0 %}+{% endif %}{{ stats.weight_change|floatformat:1 }} kg
                </div>
                {% endif %}
            </div>

            <div class="stat-card">
                <div class="stat-label">Total Entries</div>
                <div class="stat-value">
                    {{ weight_logs.count }}
                    <span class="stat-unit">logs</span>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="log-weight-card">
                <div class="card-header">
                    <h2>Log Today's Weight</h2>
                    <p>Record your weight to track your progress</p>
                </div>

                <form method="POST" action="{% url 'log-weight' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" 
                               class="form-control" 
                               id="date" 
                               name="date" 
                               value="{{ today }}" 
                               max="{{ today }}"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" 
                               class="form-control" 
                               id="weight" 
                               name="weight" 
                               step="0.1" 
                               min="1" 
                               max="500"
                               placeholder="Enter your weight"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea class="form-control" 
                                  id="notes" 
                                  name="notes" 
                                  placeholder="How are you feeling? Any observations?"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Weight</button>
                </form>
            </div>

            <div class="chart-card">
                <div class="card-header">
                    <h2>Weight Trend</h2>
                    <p>Visualize your weight changes over time</p>
                </div>

                <div class="time-period-selector">
                    <button class="time-period-btn active" data-days="30">30 Days</button>
                    <button class="time-period-btn" data-days="60">60 Days</button>
                    <button class="time-period-btn" data-days="90">90 Days</button>
                </div>

                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div class="history-card">
            <div class="card-header">
                <h2>Weight History</h2>
                <p>All your recorded weight entries</p>
            </div>

            {% if weight_logs %}
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Weight (kg)</th>
                            <th>BMI</th>
                            <th>Notes</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in weight_logs %}
                        <tr>
                            <td>{{ log.date|date:"M d, Y" }}</td>
                            <td>{{ log.weight|floatformat:1 }}</td>
                            <td>{{ log.bmi|default:"--" }}</td>
                            <td>{{ log.notes|truncatewords:10|default:"--" }}</td>
                            <td>
                                <form method="POST" 
                                      action="{% url 'delete-weight-log' log.id %}" 
                                      style="display: inline;"
                                      onsubmit="return confirm('Are you sure you want to delete this entry?');">
                                    {% csrf_token %}
                                    <button type="submit" class="delete-btn">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h3>No weight entries yet</h3>
                    <p>Start logging your weight to track your progress</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    let weightChart = null;
    let currentDays = 30;

    // Initialize chart on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadChartData(currentDays);
        
        // Time period selector
        document.querySelectorAll('.time-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentDays = parseInt(this.dataset.days);
                loadChartData(currentDays);
            });
        });
    });

    function loadChartData(days) {
        fetch(`/api/weight-chart-data/?days=${days}`)
            .then(response => response.json())
            .then(data => {
                updateChart(data.labels, data.weights);
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
            });
    }

    function updateChart(labels, weights) {
        const ctx = document.getElementById('weightChart').getContext('2d');
        
        if (weightChart) {
            weightChart.destroy();
        }

        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Weight (kg)',
                    data: weights,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#059669',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 14,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            color: '#1f2937',
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(31, 41, 55, 0.95)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return 'Weight: ' + context.parsed.y.toFixed(1) + ' kg';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(16, 185, 129, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                family: "'Inter', sans-serif"
                            },
                            color: '#6b7280',
                            padding: 8,
                            callback: function(value) {
                                return value + ' kg';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                family: "'Inter', sans-serif"
                            },
                            color: '#6b7280',
                            padding: 8,
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }
</script>
{% endblock %}
